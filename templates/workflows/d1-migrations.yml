# Cloudflare D1 ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì›Œí¬í”Œë¡œìš°
# ì‚¬ìš©ë²•: ê° ì„œë¹„ìŠ¤ ë ˆí¬ì˜ .github/workflows/ì— ë³µì‚¬í•˜ì—¬ ì‚¬ìš©

name: D1 Migrations

on:
  push:
    branches: [main]
    paths:
      - 'migrations/**'
      - '.github/workflows/d1-migrations.yml'
  pull_request:
    branches: [main]
    paths:
      - 'migrations/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ëŒ€ìƒ í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      action:
        description: 'ì‹¤í–‰í•  ì•¡ì…˜'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - status
          - dry-run

concurrency:
  group: d1-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ì·¨ì†Œí•˜ì§€ ì•ŠìŒ

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ============================================
  # 1. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ê²€ì¦
  # ============================================
  validate:
    name: Validate Migrations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate SQL syntax
        run: |
          echo "ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ê²€ì¦ ì¤‘..."

          for file in migrations/*.sql; do
            if [ -f "$file" ]; then
              echo "ê²€ì¦: $file"
              # ê¸°ë³¸ SQL ë¬¸ë²• ê²€ì¦ (sqlite3 ì‚¬ìš©)
              sqlite3 :memory: < "$file" 2>&1 || {
                echo "âŒ SQL ì˜¤ë¥˜ ë°œê²¬: $file"
                exit 1
              }
              echo "âœ… $file - ìœ íš¨í•¨"
            fi
          done

          echo "âœ… ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ê²€ì¦ ì™„ë£Œ"

      - name: Check migration naming
        run: |
          echo "ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ëª… ê·œì¹™ ê²€ì¦..."

          PATTERN="^[0-9]{4}_[a-z_]+\.sql$"

          for file in migrations/*.sql; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [[ ! $filename =~ $PATTERN ]]; then
                echo "âŒ ì˜ëª»ëœ íŒŒì¼ëª…: $filename"
                echo "   ì˜ˆìƒ í˜•ì‹: 0001_create_users.sql"
                exit 1
              fi
            fi
          done

          echo "âœ… íŒŒì¼ëª… ê·œì¹™ ê²€ì¦ ì™„ë£Œ"

  # ============================================
  # 2. Staging ë§ˆì´ê·¸ë ˆì´ì…˜ (ìë™)
  # ============================================
  migrate-staging:
    name: Migrate Staging
    runs-on: ubuntu-latest
    needs: validate
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check migration status
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations list ${{ vars.D1_DATABASE_NAME }} --env staging

      - name: Apply migrations (Dry Run)
        if: github.event_name == 'pull_request' || github.event.inputs.action == 'dry-run'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply ${{ vars.D1_DATABASE_NAME }} --env staging --dry-run

      - name: Apply migrations
        if: github.event_name != 'pull_request' && github.event.inputs.action != 'dry-run'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply ${{ vars.D1_DATABASE_NAME }} --env staging

      - name: Verify migration
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute ${{ vars.D1_DATABASE_NAME }} --env staging --command "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name"

      - name: Output summary
        run: |
          echo "## ğŸ“¦ Staging D1 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë°ì´í„°ë² ì´ìŠ¤**: ${{ vars.D1_DATABASE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**í™˜ê²½**: staging" >> $GITHUB_STEP_SUMMARY
          echo "**ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # 3. Production ë§ˆì´ê·¸ë ˆì´ì…˜ (ìˆ˜ë™)
  # ============================================
  migrate-production:
    name: Migrate Production
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.environment == 'production'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create backup
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 export ${{ vars.D1_DATABASE_NAME }} --env production --output backup-${{ github.sha }}.sql

      - name: Upload backup
        uses: actions/upload-artifact@v4
        with:
          name: d1-backup-${{ github.sha }}
          path: backup-${{ github.sha }}.sql
          retention-days: 30

      - name: Check migration status
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations list ${{ vars.D1_DATABASE_NAME }} --env production

      - name: Apply migrations (Dry Run first)
        if: github.event.inputs.action != 'status'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply ${{ vars.D1_DATABASE_NAME }} --env production --dry-run

      - name: Apply migrations
        if: github.event.inputs.action == 'apply'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply ${{ vars.D1_DATABASE_NAME }} --env production

      - name: Verify migration
        if: github.event.inputs.action == 'apply'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute ${{ vars.D1_DATABASE_NAME }} --env production --command "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name"

      - name: Output summary
        run: |
          echo "## ğŸ‰ Production D1 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë°ì´í„°ë² ì´ìŠ¤**: ${{ vars.D1_DATABASE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**í™˜ê²½**: production" >> $GITHUB_STEP_SUMMARY
          echo "**ë°±ì—…**: d1-backup-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Production D1 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨ - ${context.sha.substring(0, 7)}`,
              body: `## ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨\n\n**ì»¤ë°‹**: ${context.sha}\n**ì›Œí¬í”Œë¡œìš°**: ${context.runId}\n\në°±ì—… íŒŒì¼ì´ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¡¤ë°±ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
              labels: ['bug', 'urgent', 'database']
            });
